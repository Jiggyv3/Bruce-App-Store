function e(){try{var e=K.read({fs:"sd",path:"/bruce.conf"});Ce=e?"sd":"littlefs"}catch(_c0){Ce="littlefs"}}function t(){ye=now()+3e3}function r(){ye>0&&now()>=ye&&""!=ve&&(ve="","categories"===le?xe=!0:"scripts"===le&&(Ee=!0))}function s(){var e,t,r;ve||de||"scripts"!==le||0===re.apps.length||pe||fe||now()-Te<=200||(Te=now(),(e=re.apps[oe]).d.length>Ge&&(me=++me>e.d.length+10?0:me,n(e)),t=6*(2+Ne),r=Math.floor(Se/t),e.n.length>r&&(we=++we>e.n.length+10?0:we,a(e)))}function n(e){var t,r,s=Pe/10*5+3*(Ne+1)+3;W.drawFillRect(0,s-10,Se,20,_.black),c(1,_.white),t=e.d+"    ",r=me%t.length,W.drawText((t+t).substring(r,r+Ge),Se/2,s)}function a(e){var t,r,s,n,a=Pe/10*4;W.drawFillRect(0,a-15,Se,30,_.black),c(2,_.green),t=6*(2+Ne),r=Math.floor(Se/t),s=e.n+"    ",n=we%s.length,W.drawText((s+s).substring(n,n+r),Se/2,a)}function o(){me=0,we=0}function i(e){var t=ne[e.s];return t&&t.version?t.version:null}function c(e,t,r){W.setTextSize(e+Ne),W.setTextColor(t),W.setTextAlign(r||"center","middle")}function l(e,t,r,s){return t+("Themes"===r&&s?s:r)+"/"+(e&&"object"==typeof e&&e.destination?e.destination:e).replace(/^\/+/,"")}function g(e,t){if("UNKNOWN"!==e.v){var r=i(e)||"None";F("Available: "+e.v,1,"C","G"+t,_.grey),"None"!==r&&F("Installed: "+r,1,"C","G"+(t+1),_.grey)}}function u(){return!!V.connected()||(N("WiFi not connected"),!1)}function p(e,t,r,s){var n,a,o,i=Math.floor(Se/(6+Ne));e.length>i?(a=s%(n=e+"    ").length,o=(n.substring(a)+n.substring(0,a)).substring(0,i),W.setTextAlign("left","middle"),W.drawText(o,0,r)):(W.setTextAlign("center","middle"),W.drawText(e,t,r))}function h(e,t,r,s){var n,a;return!(e.sd&&!r&&(n=!1,"string"==typeof(a=e.sd)?n=new RegExp(a).test(t):a.length>0&&(n=a.some(function(e){return new RegExp(e).test(t)})),!n)||r&&e.sss&&e.sss!==s)}function f(e){var t,r,s;de=!0,ce=0,s=(r=!!(t=i(e)))&&t!==e.v,(be=r?s?["Update","Reinstall","Delete"]:["Reinstall","Delete"]:["Install"]).push("Back"),Ae=!0}function d(){de=!1,Ee=!0}function v(e){var t=be[ce];d(),-1!==["Install","Reinstall","Update"].indexOf(t)?O(e):"Delete"===t&&w(e)}function y(e){N(e),t()}function m(e,t,r){k(e,t,r)}function w(e){var t,r,s,n,a,o,i;m(e.n,"Deleting",!0);try{for(r=(t=x(e)).files||[],s="Themes"===t.category?Y:X,n=!1,a=0;a<r.length;a++)m(e.n,"Deleting file "+(a+1)+" of "+r.length),o=l(r[a],s,t.category,e.n),K.remove({fs:Ce,path:o})&&(n=!0);m(e.n,"Finalizing deletion"),n?(i="Themes"===t.category?t.category+"/"+e.n:t.category,0===K.readdir({fs:Ce,path:s+i}).length&&K.remove({fs:Ce,path:s+i}),delete ne[e.s],A(),Ee=!0,m("",""),U(),y("Deleted successfully!")):y("Failed deleting")}catch(_c1){y("Err: "+_c1.message)}gc()}function T(){he=!0,k("Launching","Loading categories");try{if(!u())return void(he=!1);var e=V.httpFetch(Q,{method:"GET",responseType:"json"});200===e.status?(te=e.body,le="categories",b(),j()):N("Err: "+e.status)}catch(_c2){N("Err: "+_c2.message)}N(""),he=!1,xe=!0,gc(),k(),t()}function b(){var e,t,r,s,n,a,o,i,c,l,g,u,p,f,d,v,y,m;if(te&&te.categories){e=[];try{(t=K.read({fs:Ce,path:ee}))&&(e=JSON.parse(t).categories||[])}catch(_c3){}for(r=q.getBoard(),s=Se+"x"+Pe,n=0;n<te.categories.length;n++)if(k("Launching","Processing "+(a=te.categories[n]).name),a.slug&&"updates"!==a.slug){for(o=$+"category-"+a.slug+".json",i=a.lastUpdated||0,c=0,l=-1,g=0;g<e.length;g++)if(e[g].slug===a.slug){c=e[g].lastUpdated||0,l=g;break}if(!(u=i>c))try{u=!K.read({fs:Ce,path:o})}catch(_c4){u=!0}if(u)try{if(200===(p=V.httpFetch(H+"/service/main/releases/category-"+a.slug+".min.json",{method:"GET",responseType:"json"})).status){for(f=p.body,d=[],v="themes"===a.slug||a.name&&-1!==a.name.toLowerCase().indexOf("theme"),y=0;y<f.apps.length;y++)h(m=f.apps[y],r,v,s)&&d.push(m);f.apps=d,f.count=d.length;try{K.write({fs:Ce,path:o},JSON.stringify(f,null,2),"write"),l>=0?e[l].lastUpdated=i:e.push({slug:a.slug,lastUpdated:i});try{K.write({fs:Ce,path:ee},JSON.stringify({categories:e},null,2),"write")}catch(_c5){}}catch(_c6){}}}catch(_c7){}gc()}}}function C(e){var r,s;try{if("updates"===e.slug&&!u())return void(pe=!1);if("updates"===e.slug)re=ae;else{r=$+"category-"+e.slug+".json";try{(s=K.read({fs:Ce,path:r}))?re=JSON.parse(s):N("Error loading category data")}catch(_c8){N("Error loading category data")}}}catch(_c9){N("Err: "+_c9.message)}gc(),pe=!1,k(),t()}function x(e){try{var t=V.httpFetch(H+"/service/main/repositories/"+e.s.replace(/ /g,"%20")+"/metadata.json",{method:"GET",responseType:"json"});if(200===t.status)return t.body;N("Err (A): "+t.status)}catch(_c10){N("Err (B): "+_c10.message)}gc()}function E(){try{var e=K.read({fs:Ce,path:Z});ne=e?JSON.parse(e):{}}catch(_c11){ne={}}ne["BruceDevices/App-Store/App Store"]||(ne["BruceDevices/App-Store/App Store"]={version:"0.0.0",commit:""},A()),gc()}function A(){try{K.write({fs:Ce,path:Z},JSON.stringify(ne,null,2),"write"),!pe&&se&&j()}catch(_c12){}gc()}function S(e){var t=i(e);return t?t!==e.v?{text:"UPDATE AVAILABLE",color:_.orange}:{text:"UP TO DATE",color:_.green}:{text:"NOT INSTALLED",color:_.yellow}}function P(e){var t,r,s,n,a,o,i=e.split("\n"),c=[];for(t=0;t<i.length;t++)if((r=i[t]).length<=Ge)c.push(r);else{for(s=r.split(" "),n="",a=0;a<s.length;a++)(o=n+(n.length>0?" ":"")+s[a]).length<=Ge?n=o:n.length>0?(c.push(n),n=s[a]):c.push(s[a]);n.length>0&&c.push(n)}return c}function N(e){var t,r,s,n,a,o,i,l,g;if(t=!1,null==e||ve!==e&&(""!=e&&(t=!0),ve=e),t){for(c(1,_.orange),s=(r=P(ve)).length*(Ne+1)*8+20,n=0,a=0;a<r.length;a++)r[a].length>n&&(n=r[a].length);o=n*(6*(1+Ne)),i=Math.min(Se-20,o+40),l=(Se-i)/2,g=Pe/2-s/2,W.drawFillRect(l,g,i,s,_.black),W.drawRect(l,g,i,s,_.orange),r.forEach(function(e,t){var r=g+18+t*(Ne+1)*8;W.drawText(e,Se/2,r)})}}function G(){var e,t,r,s;if(Ae){if(Ae=!1,!de||0===re.apps.length)return;e=16*be.length+24,t=Math.min(Se-40,200),r=(Se-t)/2,s=(Pe-e)/2,W.drawFillRect(r,s,t,e,_.black),W.drawRect(r,s,t,e,_.white),c(1,null,null),be.forEach(function(e,t){var n=s+16+t*(Ne+1)*10,a=t===ce?_.green:_.grey,o=t===ce?"> ":"  ";W.setTextColor(a),W.setTextAlign("left","middle"),W.drawText(o+e,r+10,n)})}}function R(){var e,t,r,s,n,a,o;if(gc(),xe){if(xe=!1,0===te.totalCategories)return F("No categories available",1,"C","G6",_.red),void F("Check WiFi",1,"C","G7",_.white);if(de)return;if(e=te.categories[oe].name,t=te.totalCategories,r=te.categories[oe].count,"Updates"!==e){s=te.categories[oe].slug,n=$+"category-"+s+".json";try{(a=K.read({fs:Ce,path:n}))&&void 0!==(o=JSON.parse(a)).count&&(r=o.count)}catch(_c13){}}F(oe+1+" of "+t,1,"C","G3",_.white),F("Updates"===e?"* "+e+" *":e,2,"C","G5","Updates"===e?_.orange:_.green),F("Updates"===e?r+" Update"+(1===r?"":"s")+" Available":r+("Themes"===e?" Theme":" App")+(1===r?"":"s"),1,"C","G7",_.white)}gc()}function U(){var e,t,r,s;if(gc(),Ee){if(Ee=!1,W.drawFillRect(0,Ue+1,Se,Pe,_.black),0===re.apps.length)return F("No apps in category",1,"C","G4",_.red),void F("Press ESC to go back",1,"C","G6",_.white);if(de)return;t=S(e=re.apps[oe]),ge&&F(ge.name+"      "+(oe+1)+" of "+re.apps.length,1,"C","G2",_.white),c(2,_.green),r=Pe/10*4,p(e.n,Se/2,r,we),c(1,_.white),s=Pe/10*5+3*(Ne+1)+3,p(e.d,Se/2,s,me),F(t.text,1,"C","G7",t.color),g(e,8)}gc()}function k(e,t,r){gc(),void 0===e&&(e=""),void 0===t&&(t=""),void 0===r&&(r=!1),r&&W.drawFillRect(0,Ue,Se,Pe,_.black),de||J||(F("Bruce App Store",2,"C","G1",BRUCE_PRICOLOR),J=!0),e!=L&&(F(e,1,"C","G4",_.cyan),L=e),t!=M&&(F(t,1,"C","G6",_.white),M=t),gc()}function F(e,t,r,s,n){var a,o=8*(2+Ne);"C"==r&&(r=Se/2),"G"===s.substring(0,1)&&(a=parseInt(s.substring(1)),s=1==a?o:(Pe-o-4)/8*(a-1)+o+4),W.drawFillRect(0,s-8*(t+Ne),Se,8*(t+Ne),_.black),c(t,n,"center"),W.setTextAlign("center","bottom"),W.drawText(e,r,s)}function O(e){var r,s,n,a,o,i,c,g,p,h;fe=!0,k(e.n,"Connecting",!0);try{if(!u())return void(fe=!1);for(k(e.n,"Installing"),r=0,s=0,a=(n=x(e)).files||[],o="Themes"===n.category?Y:X,i=0;i<a.length;i++)g=l(c=a[i],o,n.category,e.n),p=c&&"object"==typeof c&&c.source?(n.path+c.source).replace(/^\/+/,""):(n.path+c).replace(/^\/+/,""),h=(H+"/service/manual/"+n.owner+"/"+n.repo+"/"+n.commit+"/"+p).replace(/ /g,"%20"),200===V.httpFetch(h,{save:{fs:Ce,path:g,mode:"write"}}).status?(k(e.n,"Downloading "+(i+1)+" of "+a.length),r++):(s++,k("Error","Download failed for "+a[i].source)),gc();r===a.length&&0===s&&(ne[e.s]={version:n.version,commit:n.commit},A(),Ee=!0,k("",""),U(),N("Installed successfully!"))}catch(_c14){k("Error","Err (A): "+_c14.message)}gc(),fe=!1,t()}function j(){var e,t,r,s,n,a,o,c,l,g;try{if(ae={category:"Updates",slug:"updates",count:0,apps:[]},!te||!te.categories)return;for(e=0;e<te.categories.length;e++)if("updates"!==(t=te.categories[e]).slug){r=$+"category-"+t.slug+".json";try{if(s=K.read({fs:Ce,path:r}))for(n=JSON.parse(s),a=0;a<n.apps.length;a++)if((c=i(o=n.apps[a]))&&c!==o.v){for(l=!1,g=0;g<ae.apps.length;g++)if(ae.apps[g].slug===o.slug){l=!0;break}l||ae.apps.push(o)}}catch(_c15){}}ae.count=ae.apps.length,te.categories=te.categories.filter(function(e){return"updates"!==e.slug}),te.totalCategories=te.categories.length,ae.apps.length>0&&(te.categories.unshift({name:"Updates",slug:"updates",count:ae.count}),te.totalCategories++)}catch(_c16){N("Err: "+_c16.message)}gc()}function D(e){ie=oe,ge=e,le="scripts",oe=0,o(),C(e),Ee=!0}function B(){W.drawFillRect(0,Ue+1,Se,Pe,_.black),le="categories",oe=ie,re=[],ge=null,o(),xe=!0}function I(e,t,r){0!==t&&(oe=e?(oe+1)%t:(oe-1+t)%t,r&&r(),"categories"===le?xe=!0:Ee=!0)}var J,L,M,q=require("device"),W=require("display"),z=require("keyboard"),K=require("storage"),V=require("wifi"),_={black:W.color(0,0,0),grey:W.color(127,127,127),white:W.color(255,255,255),green:W.color(0,255,0),yellow:W.color(255,255,0),orange:W.color(255,165,0),red:W.color(255,0,0),cyan:W.color(0,255,255)},H="http://ghp.iceis.co.uk",Q=H+"/service/main/releases/categories.json",X="/BruceJS/",Y="/Themes/",Z="/BruceAppStore/installed.json",$="/BruceAppStore/cache/",ee="/BruceAppStore/lastUpdated.json",te=[],re=[],se={},ne={},ae=[],oe=0,ie=0,ce=0,le="categories",ge=null,ue=!1,pe=!1,he=!1,fe=!1,de=!1,ve="",ye=0,me=0,we=0,Te=0,be=[],Ce="littlefs",xe=!1,Ee=!1,Ae=!1,Se=W.width(),Pe=W.height(),Ne=Se>300?1:0,Ge=Math.trunc(Se/(6*(Ne+1))),Re=8*(1+Ne),Ue=8*(2+Ne);for(e(),E(),T(),J=!1,L="",M="";!ue;){if(z.getEscPress())if(de)d();else{if("scripts"!==le){ue=!0;break}B()}fe||(""!=ve&&(z.getNextPress()||z.getPrevPress()||z.getSelPress()||z.getEscPress())?(ve="",ye=0,"categories"===le?xe=!0:Ee=!0):de?(z.getNextPress()?(ce=(ce+1)%be.length,Ae=!0):z.getPrevPress()&&(ce=(ce-1+be.length)%be.length,Ae=!0),z.getSelPress()&&v(re.apps[oe])):"categories"===le?z.getNextPress()?I(!0,te.totalCategories):z.getPrevPress()?I(!1,te.totalCategories):z.getSelPress()&&te.totalCategories>0&&D(te.categories[oe]):z.getNextPress()?I(!0,re.apps.length,o):z.getPrevPress()?I(!1,re.apps.length,o):z.getSelPress()&&re.apps.length>0&&f(re.apps[oe]),R(),U(),G()),r(),s(),delay(50)}