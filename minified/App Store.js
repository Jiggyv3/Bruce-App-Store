var device=require("device"),display=require("display"),keyboard=require("keyboard"),storage=require("storage"),wifi=require("wifi"),colours=[display.color(0,0,0),display.color(127,127,127),display.color(255,255,255),display.color(0,255,0),display.color(255,255,0),display.color(255,165,0),display.color(255,0,0),display.color(0,255,255)],BASE_URL="https://raw.githubusercontent.com/BruceDevices/App-Store-Data/refs/heads/main/",CATEGORIES_URL=BASE_URL+"releases/categories.json",RELEASES_URL=BASE_URL+"releases/releases.json",SCRIPTS_DIR="/BruceJS/",THEMES_DIR="/Themes/",VERSION_FILE="/BruceAppStore/installed.json",CACHE_DIR="/BruceAppStore/cache/",LAST_UPDATED_FILE="/BruceAppStore/lastUpdated.json",availableCategories=[],availableScripts=[],releasesData={},installedVersions={},updatesAvailable=[],currentScript=0,lastCategoryIndex=0,selectedMenuOption=0,currentView="categories",selectedCategory=null,exitApp=!1,isLoadingScripts=!0,isDownloading=!1,showMenu=!1,statusMessage="",statusClearTime=0,descriptionScrollOffset=0,nameScrollOffset=0,lastScrollTime=0,menuOptions=[],fileSystem="littlefs",displayWidth=display.width(),displayHeight=display.height(),fontScale=displayWidth>300?1:0,maxCharacters=Math.trunc(displayWidth/(6*(fontScale+1)));function detectFileSystem(){try{fileSystem=storage.read({fs:"sd",path:"/bruce.conf"})?"sd":"littlefs"}catch(e){fileSystem="littlefs"}}function clearCacheFiles(){try{for(var e=storage.readdir({fs:fileSystem,path:CACHE_DIR}),t=0;t<e.length;t++)-1!==e[t].indexOf(".json")&&storage.remove({fs:fileSystem,path:CACHE_DIR+e[t]});var a=storage.readdir({fs:fileSystem,path:CACHE_DIR});0===a.length&&storage.remove({fs:fileSystem,path:CACHE_DIR})}catch(s){}}function clearStatusAfterDelay(){statusClearTime=now()+3e3}function checkStatusClear(){statusClearTime>0&&now()>=statusClearTime&&(statusMessage=statusClearTime="",displayInterface())}function updateDescriptionScroll(){if(!(statusMessage||showMenu||"scripts"!==currentView||0===availableScripts.apps.length||isLoadingScripts||isDownloading||now()-lastScrollTime<=100)){lastScrollTime=now();var e=availableScripts.apps[currentScript];e.description.length>maxCharacters&&(descriptionScrollOffset=++descriptionScrollOffset>e.description.length+10?0:descriptionScrollOffset,updateDescriptionArea(e)),e.name.length>maxCharacters&&(nameScrollOffset=++nameScrollOffset>e.name.length+10?0:nameScrollOffset,updateNameArea(e))}}function updateDescriptionArea(e){var t=displayHeight/10*6+(fontScale+1)*3-3;display.drawFillRect(0,t-10,displayWidth,20,colours[0]),display.setTextSize(1+fontScale),display.setTextColor(colours[2]),display.setTextAlign("center","middle");var a=e.description+"    ",s=descriptionScrollOffset%a.length;display.drawText((a+a).substring(s,s+maxCharacters),displayWidth/2,t)}function updateNameArea(e){var t=displayHeight/10*5-5;display.drawFillRect(0,t-15,displayWidth,30,colours[0]),display.setTextSize(2+fontScale),display.setTextColor(colours[3]),display.setTextAlign("center","middle");var a=e.name+"    ",s=nameScrollOffset%a.length;display.drawText((a+a).substring(s,s+maxCharacters),displayWidth/2,t)}function resetDescriptionScroll(){descriptionScrollOffset=0,nameScrollOffset=0}function showActionMenu(e){showMenu=!0,selectedMenuOption=0;var t=installedVersions[e.slug];if(t&&t.version)var a=t.version;else var a=null;var s=!!a,i=s&&a!==e.version;(menuOptions=s?i?["Update","Reinstall","Delete"]:["Reinstall","Delete"]:["Install"]).push("Back"),displayInterface()}function hideActionMenu(){showMenu=!1,displayInterface()}function executeMenuAction(e){var t=menuOptions[selectedMenuOption];hideActionMenu(),-1!==["Install","Reinstall","Update"].indexOf(t)?installScript(e):"Delete"===t&&deleteScript(e)}function deleteScript(e){try{for(var t=loadFullMetadata(e),a=t.files||[],s="Themes"===t.category?THEMES_DIR:SCRIPTS_DIR,i=!1,l=0;l<a.length;l++){if(a[l]&&"object"==typeof a[l]&&a[l].source&&a[l].destination)var r=s+t.category+"/"+a[l].destination.replace(/^\/+/,"");else var r=s+t.category+"/"+a[l].replace(/^\/+/,"");storage.remove({fs:fileSystem,path:r})&&(i=!0)}if(i){var o=storage.readdir({fs:fileSystem,path:s+t.category});0===o.length&&storage.remove({fs:fileSystem,path:s+t.category}),delete installedVersions[e.slug],saveInstalledVersions(),statusMessage=e.name+" deleted successfully!"}else statusMessage="Failed to delete script files"}catch(n){statusMessage="Error deleting script: "+n.message}displayInterface(),clearStatusAfterDelay()}function loadAvailableCategories(){isLoadingScripts=!0,displayInterface();try{if(!wifi.connected()){statusMessage="WiFi not connected. Connect via WiFi menu first.",isLoadingScripts=!1,displayInterface();return}var e=wifi.httpFetch(CATEGORIES_URL,{method:"GET",responseType:"json"});if(200===e.status){var t=(availableCategories=e.body).lastUpdated||0,a=0;try{var s=storage.read({fs:fileSystem,path:LAST_UPDATED_FILE});s&&(a=JSON.parse(s).lastUpdated||0)}catch(i){}if(t>a){clearCacheFiles();try{storage.write({fs:fileSystem,path:LAST_UPDATED_FILE},JSON.stringify({lastUpdated:t},null,2),"write")}catch(l){}}currentView="categories",createUpdatesCategory(),preloadCategoryFiles()}else statusMessage="Failed Loading Scripts (HTTP "+e.status+")"}catch(r){statusMessage="Network error (C): "+r.message}isLoadingScripts=!1,displayInterface(),clearStatusAfterDelay()}function preloadCategoryFiles(){if(availableCategories&&availableCategories.categories)for(var e=device.getBoard(),t=displayWidth+"x"+displayHeight,a=0;a<availableCategories.categories.length;a++){var s=availableCategories.categories[a];if("updates"!==s.slug){var i=CACHE_DIR+"category-"+s.slug+".json",l=!0;try{storage.read({fs:fileSystem,path:i})&&(l=!1)}catch(r){}if(l)try{console.log("Downloading category file: category-"+s.slug+".json");var o=wifi.httpFetch(BASE_URL+"releases/category-"+s.slug+".json",{method:"GET",responseType:"json"});if(200===o.status){console.log("Successfully downloaded category-"+s.slug+".json");for(var n=o.body,d=[],c="themes"===s.slug||s.name&&-1!==s.name.toLowerCase().indexOf("theme"),p=0;p<n.apps.length;p++){var g=n.apps[p],u=!0;if(g["supported-devices"]&&!c){var y=!1;if("string"==typeof g["supported-devices"]){var f=RegExp(g["supported-devices"]);y=f.test(e)}else if(g["supported-devices"].length>0)for(var h=0;h<g["supported-devices"].length;h++){var S=g["supported-devices"][h],f=RegExp(S);if(f.test(e)){y=!0;break}}y||(u=!1)}u&&c&&g["supported-screen-size"]&&g["supported-screen-size"]!==t&&(u=!1),u&&d.push(g)}n.apps=d,n.count=d.length;try{storage.write({fs:fileSystem,path:i},JSON.stringify(n,null,2),"write")}catch(v){}}}catch($){}}}}function loadCategory(e){try{if("updates"===e.slug&&!wifi.connected()){statusMessage="WiFi not connected. Connect via WiFi menu first.",isLoadingScripts=!1,displayInterface();return}if("updates"===e.slug)availableScripts=updatesAvailable;else{var t=CACHE_DIR+"category-"+e.slug+".json";try{var a=storage.read({fs:fileSystem,path:t});a?availableScripts=JSON.parse(a):statusMessage="Category data not available. Please restart app."}catch(s){statusMessage="Error loading category data. Please restart app."}}}catch(i){statusMessage="Error loading category: "+i.message}isLoadingScripts=!1,displayInterface(),clearStatusAfterDelay()}function loadFullMetadata(e){try{var t=wifi.httpFetch(BASE_URL+"repositories/"+e.slug.replace(/ /g,"%20")+"/metadata.json",{method:"GET",responseType:"json"});if(200===t.status)return t.body;statusMessage="Failed Loading Metadata (HTTP "+t.status+")"}catch(a){statusMessage="Network error (B): "+a.message}}function loadInstalledVersions(){try{var e=storage.read({fs:fileSystem,path:VERSION_FILE});installedVersions=e?JSON.parse(e):{}}catch(t){installedVersions={}}installedVersions["BruceDevices/App-Store/App Store"]||(installedVersions["BruceDevices/App-Store/App Store"]={version:"0.0.0",commit:""},saveInstalledVersions())}function saveInstalledVersions(){try{storage.write({fs:fileSystem,path:VERSION_FILE},JSON.stringify(installedVersions,null,2),"write"),!isLoadingScripts&&releasesData&&createUpdatesCategory()}catch(e){}}function needsUpdate(e){return installedVersions[e.slug]!==e.version}function getScriptStatus(e){var t=installedVersions[e.slug];if(t&&t.version)var a=t.version;else var a=null;return a?a!==e.version?{text:"UPDATE AVAILABLE",color:colours[5]}:{text:"UP TO DATE",color:colours[3]}:{text:"NOT INSTALLED",color:colours[4]}}function splitTextIntoLines(e){for(var t=e.split("\n"),a=[],s=0;s<t.length;s++){var i=t[s];if(i.length<=maxCharacters)a.push(i);else{for(var l=i.split(" "),r="",o=0;o<l.length;o++){var n=r+(r.length>0?" ":"")+l[o];n.length<=maxCharacters?r=n:r.length>0?(a.push(r),r=l[o]):a.push(l[o])}r.length>0&&a.push(r)}}return a}function drawStatusMessage(){if(statusMessage&&!isDownloading&&!isLoadingScripts){display.setTextSize(1+fontScale),display.setTextColor(colours[5]),display.setTextAlign("center","middle");for(var e=splitTextIntoLines(statusMessage),t=e.length*(fontScale+1)*8+20,a=0,s=0;s<e.length;s++)e[s].length>a&&(a=e[s].length);var i=Math.min(displayWidth-20,a*(6*(1+fontScale))+40),l=(displayWidth-i)/2,r=displayHeight/2-t/2;display.drawFillRect(l,r,i,t,colours[0]),display.drawRect(l,r,i,t,colours[5]);for(var s=0;s<e.length;s++){var o=r+18+s*(fontScale+1)*8;display.drawText(e[s],displayWidth/2,o)}}}function drawActionMenu(){if(showMenu&&0!==availableScripts.apps.length){var e=16*menuOptions.length+24,t=Math.min(displayWidth-40,200),a=(displayWidth-t)/2,s=(displayHeight-e)/2;display.drawFillRect(a,s,t,e,colours[0]),display.drawRect(a,s,t,e,colours[2]),display.setTextSize(1+fontScale);for(var i=0;i<menuOptions.length;i++){var l=s+16+i*(fontScale+1)*10,r=i===selectedMenuOption?colours[3]:colours[1],o=i===selectedMenuOption?"> ":"  ";display.setTextColor(r),display.setTextAlign("left","middle"),display.drawText(o+menuOptions[i],a+10,l)}}}function drawCategoryView(){if(0===availableCategories.totalCategories){display.setTextSize(1+fontScale),display.setTextColor(colours[6]),display.drawText("No categories available",displayWidth/2,displayHeight/2-10),display.setTextColor(colours[2]),display.drawText("Check network connection",displayWidth/2,displayHeight/2+10);return}if(!showMenu){var e=availableCategories.categories[currentScript].name,t=availableCategories.totalCategories,a=availableCategories.categories[currentScript].count;if("Updates"!==e){var s=availableCategories.categories[currentScript].slug;try{var i=storage.read({fs:fileSystem,path:CACHE_DIR+"category-"+s+".json"});if(i){var l=JSON.parse(i);void 0!==l.count&&(a=l.count)}}catch(r){}}display.setTextSize(1+fontScale),display.setTextColor(colours[2]),display.drawText(currentScript+1+" of "+t,displayWidth/2,displayHeight/10*2),display.setTextSize(2+fontScale),display.setTextColor("Updates"===e?colours[5]:colours[3]),display.drawText("Updates"===e?"* "+e+" *":e,displayWidth/2,displayHeight/10*3+7),display.setTextSize(1+fontScale),display.setTextColor(colours[2]);var o="Updates"===e?a+" update"+(1===a?"":"s")+" available":a+" available";display.drawText(o,displayWidth/2,displayHeight/2),display.setTextColor(colours[1]),display.drawText("Press Select to browse",displayWidth/2,displayHeight/10*7-10),display.drawText("category",displayWidth/2,displayHeight/10*8-10)}}function drawScriptView(){if(0===availableScripts.apps.length){display.setTextSize(1+fontScale),display.setTextColor(colours[6]),display.drawText("No apps in category",displayWidth/2,displayHeight/2-10),display.setTextColor(colours[2]),display.drawText("Press ESC to go back",displayWidth/2,displayHeight/2+10);return}if(!showMenu){var e=availableScripts.apps[currentScript],t=getScriptStatus(e);selectedCategory&&(display.setTextColor(colours[3]),display.setTextSize(1+fontScale),display.drawText(selectedCategory.name,displayWidth/2,displayHeight/10*2)),display.setTextSize(1+fontScale),display.setTextColor(colours[2]),display.drawText(currentScript+1+" of "+availableScripts.apps.length,displayWidth/2,displayHeight/10*3),display.setTextSize(2+fontScale),display.setTextColor(colours[3]);var a=displayHeight/10*5-5;if(e.name.length>maxCharacters){var s=e.name+"    ",i=nameScrollOffset%s.length,l=s.substring(i)+s.substring(0,i),r=l.substring(0,maxCharacters);display.setTextAlign("left","middle"),display.drawText(r,0,a)}else display.setTextAlign("center","middle"),display.drawText(e.name,displayWidth/2,a);display.setTextSize(1+fontScale),display.setTextColor(colours[2]);var o=displayHeight/10*6+(fontScale+1)*3-3;if(e.description.length>maxCharacters){var s=e.description+"    ",i=descriptionScrollOffset%s.length,l=s.substring(i)+s.substring(0,i),r=l.substring(0,maxCharacters);display.setTextAlign("left","middle"),display.drawText(r,0,o)}else display.setTextAlign("center","middle"),display.drawText(e.description,displayWidth/2,o);if(display.setTextAlign("center","middle"),display.setTextColor(t.color),display.drawText(t.text,displayWidth/2,displayHeight/10*8-(fontScale+1)*3),display.setTextColor(colours[1]),"UNKNOWN"!==e.version){var n="None";installedVersions[e.slug]&&installedVersions[e.slug].version&&(n=installedVersions[e.slug].version),display.drawText("Available: "+e.version,displayWidth/2,displayHeight/10*9-(fontScale+1)*3),"None"!==n&&display.drawText("Installed: "+n,displayWidth/2,displayHeight/10*10-(fontScale+1)*3)}}}function displayInterface(){if(showMenu||(display.fill(colours[0]),display.setTextAlign("center","middle"),display.setTextSize(2+fontScale),display.setTextColor(BRUCE_PRICOLOR),display.drawText("Bruce App Store",displayWidth/2,7+5*fontScale)),isLoadingScripts){display.setTextSize(1+fontScale),display.setTextColor(colours[7]),display.drawText("Loading...",displayWidth/2,displayHeight/2-10),display.setTextColor(colours[2]),display.drawText("Fetching latest versions",displayWidth/2,displayHeight/2+10);return}if(isDownloading){display.setTextSize(1+fontScale),display.setTextColor(colours[7]),display.drawText("Downloading...",displayWidth/2,displayHeight/2-20),display.drawFillRect(0,displayHeight/2+10,displayWidth,20,colours[0]),display.setTextColor(colours[2]),display.drawText(statusMessage,displayWidth/2,displayHeight/2+20);return}"categories"===currentView?drawCategoryView():drawScriptView(),drawStatusMessage(),drawActionMenu(),isDownloading||isLoadingScripts||"scripts"===currentView||(display.setTextSize(1+fontScale),display.setTextColor(colours[1]),display.drawText("Back: Close App",displayWidth/2,displayHeight-15))}function installScript(e){isDownloading=!0,statusMessage="Connecting...",displayInterface();try{if(!wifi.connected()){statusMessage="WiFi not connected",isDownloading=!1,displayInterface();return}statusMessage=e.name,displayInterface();for(var t=0,a=0,s=loadFullMetadata(e),i=s.files||[],l="Themes"===s.category?THEMES_DIR:SCRIPTS_DIR,r=0;r<i.length;r++){if(i[r]&&"object"==typeof i[r]&&i[r].source&&i[r].destination)var o=l+s.category+"/"+i[r].destination.replace(/^\/+/,""),n=(s.path+i[r].source).replace(/^\/+/,"");else var o=l+s.category+"/"+i[r].replace(/^\/+/,""),n=(s.path+i[r]).replace(/^\/+/,"");var d=("https://raw.githubusercontent.com/"+s.owner+"/"+s.repo+"/"+s.commit+"/"+n).replace(/ /g,"%20");console.log("Downloading file "+(r+1)+" of "+i.length+": "+n);var c=wifi.httpFetch(d,{save:{fs:fileSystem,path:o}});200===c.status?(console.log("Successfully downloaded: "+n),statusMessage="Downloading "+(r+1)+" of "+i.length+"...",displayInterface(),t++):(console.log("Failed to download "+n+": HTTP "+c.status),a++,statusMessage="Download failed: HTTP "+c.status+" for "+i[r].source)}t===i.length&&0===a&&(installedVersions[e.slug]={version:s.version,commit:s.commit},saveInstalledVersions(),statusMessage=e.name+"\ninstalled successfully!")}catch(p){statusMessage="Error (A): "+p.message}isDownloading=!1,displayInterface(),clearStatusAfterDelay()}function createUpdatesCategory(){try{if(updatesAvailable={category:"Updates",slug:"updates",count:0,apps:[]},!availableCategories||!availableCategories.categories)return;for(var e=0;e<availableCategories.categories.length;e++){var t=availableCategories.categories[e];if("updates"!==t.slug){var a=CACHE_DIR+"category-"+t.slug+".json";try{var s=storage.read({fs:fileSystem,path:a});if(s)for(var i=JSON.parse(s),l=0;l<i.apps.length;l++){var r=i.apps[l],o=installedVersions[r.slug],n=null;if(o&&o.version&&(n=o.version),n&&n!==r.version){for(var d=!1,c=0;c<updatesAvailable.apps.length;c++)if(updatesAvailable.apps[c].slug===r.slug){d=!0;break}d||updatesAvailable.apps.push(r)}}}catch(p){}}}updatesAvailable.count=updatesAvailable.apps.length;for(var g=[],u=0;u<availableCategories.categories.length;u++)"updates"!==availableCategories.categories[u].slug&&g.push(availableCategories.categories[u]);if(availableCategories.categories=g,availableCategories.totalCategories=availableCategories.categories.length,updatesAvailable.apps.length>0){for(var y=[{name:"Updates",slug:"updates",count:updatesAvailable.count}],f=0;f<availableCategories.categories.length;f++)y.push(availableCategories.categories[f]);availableCategories.categories=y,availableCategories.totalCategories=availableCategories.categories.length}}catch(h){statusMessage="Error creating Updates category: "+h.message}}function selectCategory(e){lastCategoryIndex=currentScript,selectedCategory=e,currentView="scripts",currentScript=0,resetDescriptionScroll(),loadCategory(e),displayInterface()}function goBackToCategories(){currentView="categories",currentScript=lastCategoryIndex,availableScripts=[],selectedCategory=null,resetDescriptionScroll(),displayInterface()}function handleNavigation(e,t,a){0!==t&&(currentScript=e?(currentScript+1)%t:(currentScript-1+t)%t,a&&a(),displayInterface())}for(detectFileSystem(),loadInstalledVersions(),loadAvailableCategories(),displayInterface();!exitApp;){if(keyboard.getEscPress()){if(showMenu)hideActionMenu();else if("scripts"===currentView)goBackToCategories();else{exitApp=!0;break}}!isDownloading&&(statusMessage&&(keyboard.getNextPress()||keyboard.getPrevPress()||keyboard.getSelPress()||keyboard.getEscPress())&&(statusMessage="",statusClearTime=0,displayInterface()),showMenu?(keyboard.getNextPress()?(selectedMenuOption=(selectedMenuOption+1)%menuOptions.length,displayInterface()):keyboard.getPrevPress()&&(selectedMenuOption=(selectedMenuOption-1+menuOptions.length)%menuOptions.length,displayInterface()),keyboard.getSelPress()&&executeMenuAction(availableScripts.apps[currentScript])):"categories"===currentView?keyboard.getNextPress()?handleNavigation(!0,availableCategories.totalCategories):keyboard.getPrevPress()?handleNavigation(!1,availableCategories.totalCategories):keyboard.getSelPress()&&availableCategories.totalCategories>0&&selectCategory(availableCategories.categories[currentScript]):keyboard.getNextPress()?handleNavigation(!0,availableScripts.apps.length,resetDescriptionScroll):keyboard.getPrevPress()?handleNavigation(!1,availableScripts.apps.length,resetDescriptionScroll):keyboard.getSelPress()&&availableScripts.apps.length>0&&showActionMenu(availableScripts.apps[currentScript])),checkStatusClear(),updateDescriptionScroll(),delay(50)}