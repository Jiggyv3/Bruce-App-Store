function e(){try{var e=V.read({fs:"sd",path:"/bruce.conf"});Ee=e?"sd":"littlefs"}catch(_c0){Ee="littlefs"}}function t(){we=now()+3e3}function r(){we>0&&now()>=we&&""!=me&&(me="","categories"===ue?Ae=!0:"scripts"===ue&&(Pe=!0))}function s(){if(!(me||ye||"scripts"!==ue||0===ne.apps.length||he||ve||now()-Ce<=100)){Ce=now();var e=ne.apps[ce];e.description.length>Re&&(Te=++Te>e.description.length+10?0:Te,n(e)),e.name.length>Re&&(be=++be>e.name.length+10?0:be,a(e))}}function n(e){var t,r,s=ke/10*5+3*(Ge+1)+3;H.drawFillRect(0,s-10,Ne,20,Q.black),c(1,Q.white),t=e.description+"    ",r=Te%t.length,H.drawText((t+t).substring(r,r+Re),Ne/2,s)}function a(e){var t,r,s=ke/10*4;H.drawFillRect(0,s-15,Ne,30,Q.black),c(2,Q.green),t=e.name+"    ",r=be%t.length,H.drawText((t+t).substring(r,r+Re),Ne/2,s)}function o(){Te=0,be=0}function i(e){var t=oe[e.slug];return t&&t.version?t.version:null}function c(e,t,r){H.setTextSize(e+Ge),H.setTextColor(t),H.setTextAlign(r||"center","middle")}function l(e,t,r){return e&&"object"==typeof e&&e.destination?t+r+"/"+e.destination.replace(/^\/+/,""):t+r+"/"+e.replace(/^\/+/,"")}function g(e,t){if("UNKNOWN"!==e.version){var r=i(e)||"None";j("Available: "+e.version,1,"C","G"+t,Q.grey),"None"!==r&&j("Installed: "+r,1,"C","G"+(t+1),Q.grey)}}function u(){return!!_.connected()||(G("WiFi not connected"),!1)}function p(e,t,r,s){var n,a,o,i=Math.floor(Ne/(6+Ge));e.length>i?(a=s%(n=e+"    ").length,o=(n.substring(a)+n.substring(0,a)).substring(0,i),H.setTextAlign("left","middle"),H.drawText(o,0,r)):(H.setTextAlign("center","middle"),H.drawText(e,t,r))}function f(e,t,r,s,n){c(t,n,r),j(e,t,r,s,n)}function h(e,t,r,s){var n,a;return!(e.sd&&!r&&(n=!1,"string"==typeof(a=e.sd)?n=new RegExp(a).test(t):a.length>0&&(n=a.some(function(e){return new RegExp(e).test(t)})),!n)||r&&e.sss&&e.sss!==s)}function d(e){var t,r,s;ye=!0,ge=0,s=(r=!!(t=i(e)))&&t!==e.version,(xe=r?s?["Update","Reinstall","Delete"]:["Reinstall","Delete"]:["Install"]).push("Back"),Se=!0}function v(){ye=!1,Pe=!0}function y(e){var t=xe[ge];v(),-1!==["Install","Reinstall","Update"].indexOf(t)?D(e):"Delete"===t&&T(e)}function m(e){G(e),t()}function w(e,t,r){O(e,t,r)}function T(e){var t,r,s,n,a,o;w(e.name,"Deleting",!0);try{for(r=(t=E(e)).files||[],s="Themes"===t.category?$:Z,n=!1,a=0;a<r.length;a++)w(e.name,"Deleting file "+(a+1)+" of "+r.length),o=l(r[a],s,t.category),V.remove({fs:Ee,path:o})&&(n=!0);w(e.name,"Finalizing deletion"),n?(0===V.readdir({fs:Ee,path:s+t.category}).length&&V.remove({fs:Ee,path:s+t.category}),delete oe[e.slug],P(),Pe=!0,w("",""),F(),m("Deleted successfully!")):m("Failed deleting")}catch(_c1){m("Err: "+_c1.message)}}function b(){de=!0,O("Launching","Loading categories");try{if(!u())return void(de=!1);var e=_.httpFetch(Y,{method:"GET",responseType:"json"});200===e.status?(se=e.body,ue="categories",C(),B()):G("Err: "+e.status)}catch(_c2){G("Err: "+_c2.message)}G(""),de=!1,Ae=!0,O(),t()}function C(){var e,t,r,s,n,a,o,i,c,l,g,u,p,f,d,v,y,m;if(se&&se.categories){e=[];try{(t=V.read({fs:Ee,path:re}))&&(e=JSON.parse(t).categories||[])}catch(_c3){}for(r=z.getBoard(),s=Ne+"x"+ke,n=0;n<se.categories.length;n++)if(O("Launching","Processing "+(a=se.categories[n]).name),a.slug&&"updates"!==a.slug){for(o=te+"category-"+a.slug+".json",i=a.lastUpdated||0,c=0,l=-1,g=0;g<e.length;g++)if(e[g].slug===a.slug){c=e[g].lastUpdated||0,l=g;break}if(!(u=i>c))try{u=!V.read({fs:Ee,path:o})}catch(_c4){u=!0}if(u)try{if(200===(p=_.httpFetch(X+"releases/category-"+a.slug+".json",{method:"GET",responseType:"json"})).status){for(f=p.body,d=[],v="themes"===a.slug||a.name&&-1!==a.name.toLowerCase().indexOf("theme"),y=0;y<f.apps.length;y++)h(m=f.apps[y],r,v,s)&&d.push(m);f.apps=d,f.count=d.length;try{V.write({fs:Ee,path:o},JSON.stringify(f,null,2),"write"),l>=0?e[l].lastUpdated=i:e.push({slug:a.slug,lastUpdated:i});try{V.write({fs:Ee,path:re},JSON.stringify({categories:e},null,2),"write")}catch(_c5){}}catch(_c6){}}}catch(_c7){}}}}function x(e){var r,s;try{if("updates"===e.slug&&!u())return void(he=!1);if("updates"===e.slug)ne=ie;else{r=te+"category-"+e.slug+".json";try{(s=V.read({fs:Ee,path:r}))?ne=JSON.parse(s):G("Error loading category data")}catch(_c8){G("Error loading category data")}}}catch(_c9){G("Err: "+_c9.message)}he=!1,O(),t()}function E(e){try{var t=_.httpFetch(X+"repositories/"+e.slug.replace(/ /g,"%20")+"/metadata.json",{method:"GET",responseType:"json"});if(200===t.status)return t.body;G("Err (A): "+t.status)}catch(_c10){G("Err (B): "+_c10.message)}}function A(){try{var e=V.read({fs:Ee,path:ee});oe=e?JSON.parse(e):{}}catch(_c11){oe={}}oe["BruceDevices/App-Store/App Store"]||(oe["BruceDevices/App-Store/App Store"]={version:"0.0.0",commit:""},P())}function P(){try{V.write({fs:Ee,path:ee},JSON.stringify(oe,null,2),"write"),!he&&ae&&B()}catch(_c12){}}function S(e){return oe[e.slug]!==e.version}function N(e){var t=i(e);return t?t!==e.version?{text:"UPDATE AVAILABLE",color:Q.orange}:{text:"UP TO DATE",color:Q.green}:{text:"NOT INSTALLED",color:Q.yellow}}function k(e){var t,r,s,n,a,o,i=e.split("\n"),c=[];for(t=0;t<i.length;t++)if((r=i[t]).length<=Re)c.push(r);else{for(s=r.split(" "),n="",a=0;a<s.length;a++)(o=n+(n.length>0?" ":"")+s[a]).length<=Re?n=o:n.length>0?(c.push(n),n=s[a]):c.push(s[a]);n.length>0&&c.push(n)}return c}function G(e){var t,r,s,n,a,o,i,l,g;if(t=!1,null==e||me!==e&&(""!=e&&(t=!0),me=e),t){for(c(1,Q.orange),s=(r=k(me)).length*(Ge+1)*8+20,n=0,a=0;a<r.length;a++)r[a].length>n&&(n=r[a].length);o=n*(6*(1+Ge)),i=Math.min(Ne-20,o+40),l=(Ne-i)/2,g=ke/2-s/2,H.drawFillRect(l,g,i,s,Q.black),H.drawRect(l,g,i,s,Q.orange),r.forEach(function(e,t){var r=g+18+t*(Ge+1)*8;H.drawText(e,Ne/2,r)})}}function R(){var e,t,r,s;if(Se){if(Se=!1,!ye||0===ne.apps.length)return;e=16*xe.length+24,t=Math.min(Ne-40,200),r=(Ne-t)/2,s=(ke-e)/2,H.drawFillRect(r,s,t,e,Q.black),H.drawRect(r,s,t,e,Q.white),c(1,null,null),xe.forEach(function(e,t){var n=s+16+t*(Ge+1)*10,a=t===ge?Q.green:Q.grey,o=t===ge?"> ":"  ";H.setTextColor(a),H.setTextAlign("left","middle"),H.drawText(o+e,r+10,n)})}}function U(){var e,t,r,s,n,a,o;if(Ae){if(Ae=!1,0===se.totalCategories)return j("No categories available",1,"C","G6",Q.red),void j("Check WiFi",1,"C","G7",Q.white);if(ye)return;if(e=se.categories[ce].name,t=se.totalCategories,r=se.categories[ce].count,"Updates"!==e){s=se.categories[ce].slug,n=te+"category-"+s+".json";try{(a=V.read({fs:Ee,path:n}))&&void 0!==(o=JSON.parse(a)).count&&(r=o.count)}catch(_c13){}}j(ce+1+" of "+t,1,"C","G3",Q.white),j("Updates"===e?"* "+e+" *":e,2,"C","G5","Updates"===e?Q.orange:Q.green),j("Updates"===e?r+" Update"+(1===r?"":"s")+" Available":r+("Theme"===e?" theme":" App")+(1===r?"":"s"),1,"C","G7",Q.white)}}function F(){var e,t,r,s;if(Pe){if(Pe=!1,H.drawFillRect(0,Fe+1,Ne,ke,Q.black),0===ne.apps.length)return j("No apps in category",1,"C","G4",Q.red),void j("Press ESC to go back",1,"C","G6",Q.white);if(ye)return;t=N(e=ne.apps[ce]),pe&&j(pe.name+"      "+(ce+1)+" of "+ne.apps.length,1,"C","G2",Q.white),c(2,Q.green),r=ke/10*4,p(e.name,Ne/2,r,be),c(1,Q.white),s=ke/10*5+3*(Ge+1)+3,p(e.description,Ne/2,s,Te),j(t.text,1,"C","G7",t.color),g(e,8)}}function O(e,t,r){void 0===e&&(e=""),void 0===t&&(t=""),void 0===r&&(r=!1),r&&H.drawFillRect(0,Fe,Ne,ke,Q.black),ye||q||(j("Bruce App Store",2,"C","G1",BRUCE_PRICOLOR),q=!0),e!=M&&(j(e,1,"C","G4",Q.cyan),M=e),t!=W&&(j(t,1,"C","G6",Q.white),W=t)}function j(e,t,r,s,n){var a,o=8*(2+Ge);"C"==r&&(r=Ne/2),"G"===s.substring(0,1)&&(a=parseInt(s.substring(1)),s=1==a?o:(ke-o-4)/8*(a-1)+o+4),H.drawFillRect(0,s-8*(t+Ge),Ne,8*(t+Ge),Q.black),c(t,n,"center"),H.setTextAlign("center","bottom"),H.drawText(e,r,s)}function D(e){var r,s,n,a,o,i,c,g,p,f,h;ve=!0,O(e.name,"Connecting",!0);try{if(!u())return void(ve=!1);for(O(e.name,"Installing"),r=0,s=0,a=(n=E(e)).files||[],o="Themes"===n.category?$:Z,i=0;i<a.length;i++)g=l(c=a[i],o,n.category),p=c&&"object"==typeof c&&c.source?(n.path+c.source).replace(/^\/+/,""):(n.path+c).replace(/^\/+/,""),f=("http://ghp.iceis.co.uk/service/manual/"+n.owner+"/"+n.repo+"/"+n.commit+"/"+p).replace(/ /g,"%20"),200===(h=_.httpFetch(f,{save:{fs:Ee,path:g,mode:"write"}})).status?(O(e.name,"Downloading "+(i+1)+" of "+a.length),r++):(s++,O("Error","Download failed: HTTP "+h.status+" for "+a[i].source));r===a.length&&0===s&&(oe[e.slug]={version:n.version,commit:n.commit},P(),Pe=!0,O("",""),F(),G("Installed successfully!"))}catch(_c14){O("Error","Err (A): "+_c14.message)}ve=!1,t()}function B(){var e,t,r,s,n,a,o,c,l,g;try{if(ie={category:"Updates",slug:"updates",count:0,apps:[]},!se||!se.categories)return;for(e=0;e<se.categories.length;e++)if("updates"!==(t=se.categories[e]).slug){r=te+"category-"+t.slug+".json";try{if(s=V.read({fs:Ee,path:r}))for(n=JSON.parse(s),a=0;a<n.apps.length;a++)if((c=i(o=n.apps[a]))&&c!==o.version){for(l=!1,g=0;g<ie.apps.length;g++)if(ie.apps[g].slug===o.slug){l=!0;break}l||ie.apps.push(o)}}catch(_c15){}}ie.count=ie.apps.length,se.categories=se.categories.filter(function(e){return"updates"!==e.slug}),se.totalCategories=se.categories.length,ie.apps.length>0&&(se.categories.unshift({name:"Updates",slug:"updates",count:ie.count}),se.totalCategories++)}catch(_c16){G("Err: "+_c16.message)}}function I(e){le=ce,pe=e,ue="scripts",ce=0,o(),x(e),Pe=!0}function J(){H.drawFillRect(0,Fe+1,Ne,ke,Q.black),ue="categories",ce=le,ne=[],pe=null,o(),Ae=!0}function L(e,t,r){0!==t&&(ce=e?(ce+1)%t:(ce-1+t)%t,r&&r(),"categories"===ue?Ae=!0:Pe=!0)}var q,M,W,z=require("device"),H=require("display"),K=require("keyboard"),V=require("storage"),_=require("wifi"),Q={black:H.color(0,0,0),grey:H.color(127,127,127),white:H.color(255,255,255),green:H.color(0,255,0),yellow:H.color(255,255,0),orange:H.color(255,165,0),red:H.color(255,0,0),cyan:H.color(0,255,255)},X="http://ghp.iceis.co.uk/service/main/",Y=X+"releases/categories.json",Z="/BruceJS/",$="/Themes/",ee="/BruceAppStore/installed.json",te="/BruceAppStore/cache/",re="/BruceAppStore/lastUpdated.json",se=[],ne=[],ae={},oe={},ie=[],ce=0,le=0,ge=0,ue="categories",pe=null,fe=!1,he=!1,de=!1,ve=!1,ye=!1,me="",we=0,Te=0,be=0,Ce=0,xe=[],Ee="littlefs",Ae=!1,Pe=!1,Se=!1,Ne=H.width(),ke=H.height(),Ge=Ne>300?1:0,Re=Math.trunc(Ne/(6*(Ge+1))),Ue=8*(1+Ge),Fe=8*(2+Ge);for(e(),A(),b(),q=!1,M="",W="";!fe;){if(K.getEscPress())if(ye)v();else{if("scripts"!==ue){fe=!0;break}J()}ve||(""!=me&&(K.getNextPress()||K.getPrevPress()||K.getSelPress()||K.getEscPress())?(me="",we=0,"categories"===ue?Ae=!0:Pe=!0):ye?(K.getNextPress()?(ge=(ge+1)%xe.length,Se=!0):K.getPrevPress()&&(ge=(ge-1+xe.length)%xe.length,Se=!0),K.getSelPress()&&y(ne.apps[ce])):"categories"===ue?K.getNextPress()?L(!0,se.totalCategories):K.getPrevPress()?L(!1,se.totalCategories):K.getSelPress()&&se.totalCategories>0&&I(se.categories[ce]):K.getNextPress()?L(!0,ne.apps.length,o):K.getPrevPress()?L(!1,ne.apps.length,o):K.getSelPress()&&ne.apps.length>0&&d(ne.apps[ce]),U(),F(),R()),r(),s(),delay(50)}