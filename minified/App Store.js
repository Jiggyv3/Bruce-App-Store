function e(e){return-1!==e.indexOf("https://raw.githubusercontent.com/BruceDevices/App-Store-Data/refs/heads/main/")?e=e.replace("https://raw.githubusercontent.com/BruceDevices/App-Store-Data/refs/heads/main/","http://ghp.iceis.co.uk/service/main/"):-1!==e.indexOf("https://raw.githubusercontent.com/")&&(e=e.replace("https://raw.githubusercontent.com/","http://ghp.iceis.co.uk/service/manual/")),e}function t(){try{var e=L.read({fs:"sd",path:"/bruce.conf"});me=e?"sd":"littlefs"}catch(_c0){me="littlefs"}}function r(){var e,t;try{for(e=L.readdir({fs:me,path:_}),t=0;t<e.length;t++)-1!==e[t].indexOf(".json")&&L.remove({fs:me,path:_+e[t]});0===L.readdir({fs:me,path:_}).length&&L.remove({fs:me,path:_})}catch(_c1){}}function s(){ue=now()+3e3}function n(){ue>0&&now()>=ue&&""!=pe&&(pe="","categories"===ne?ye=!0:"scripts"===ne&&(we=!0))}function a(){if(!(pe||ge||"scripts"!==ne||0===Y.apps.length||ie||le||now()-fe<=100)){fe=now();var e=Y.apps[te];e.description.length>Ae&&(he=++he>e.description.length+10?0:he,o(e)),e.name.length>Ae&&(de=++de>e.name.length+10?0:de,i(e))}}function o(e){var t,r,s=be/10*5+3*(Se+1)+3;B.drawFillRect(0,s-10,xe,20,W.black),B.setTextSize(1+Se),B.setTextColor(W.white),B.setTextAlign("center","middle"),t=e.description+"    ",r=he%t.length,B.drawText((t+t).substring(r,r+Ae),xe/2,s)}function i(e){var t,r,s=be/10*4;B.drawFillRect(0,s-15,xe,30,W.black),B.setTextSize(2+Se),B.setTextColor(W.green),B.setTextAlign("center","middle"),t=e.name+"    ",r=de%t.length,B.drawText((t+t).substring(r,r+Ae),xe/2,s)}function c(){he=0,de=0}function l(e){var t,r,s,n;ge=!0,se=0,n=(s=!!(r=(t=$[e.slug])&&t.version?t.version:null))&&r!==e.version,(ve=s?n?["Update","Reinstall","Delete"]:["Reinstall","Delete"]:["Install"]).push("Back"),Te=!0}function g(){ge=!1,we=!0}function p(e){var t=ve[se];g(),-1!==["Install","Reinstall","Update"].indexOf(t)?N(e):"Delete"===t&&u(e)}function u(e){var t,r,n,a,o,i;C(e.name,"Deleting...",!0);try{for(r=(t=v(e)).files||[],n="Themes"===t.category?K:M,a=!1,o=0;o<r.length;o++)C(e.name,"Deleting file "+(o+1)+" of "+r.length),i=r[o]&&"object"==typeof r[o]&&r[o].source&&r[o].destination?n+t.category+"/"+r[o].destination.replace(/^\/+/,""):n+t.category+"/"+r[o].replace(/^\/+/,""),L.remove({fs:me,path:i})&&(a=!0);C(e.name,"Finalizing deletion..."),a?(0===L.readdir({fs:me,path:n+t.category}).length&&L.remove({fs:me,path:n+t.category}),delete $[e.slug],y(),we=!0,C("",""),P(),b("Deleted successfully!")):b("Failed to delete script files")}catch(_c2){b("Error deleting script: "+_c2.message)}s()}function h(){var t,r;ce=!0,C("Launching","Fetching categories...");try{if(!I.connected())return b("WiFi not connected. Connect via WiFi menu first."),void(ce=!1);t=e(H),200===(r=I.httpFetch(t,{method:"GET",responseType:"json"})).status?(X=r.body,ne="categories",d(),k()):b("Failed Loading Scripts (HTTP "+r.status+")")}catch(_c3){b("Network error (C): "+_c3.message)}b(""),ce=!1,ye=!0,C(),s()}function d(){var t,r,s,n,a,o,i,c,l,g,p,u,h,d,f,v,m,y,w,T,x,b,S;if(X&&X.categories){t=[];try{(r=L.read({fs:me,path:Q}))&&(t=JSON.parse(r).categories||[])}catch(_c4){}for(s=j.getBoard(),n=xe+"x"+be,a=0;a<X.categories.length;a++)if(C("Launching","Processing "+(o=X.categories[a]).name+"..."),o.slug&&"updates"!==o.slug){for(i=_+"category-"+o.slug+".json",c=o.lastUpdated||0,l=0,g=-1,p=0;p<t.length;p++)if(t[p].slug===o.slug){l=t[p].lastUpdated||0,g=p;break}if(!(u=c>l)){u=!0;try{u=!L.read({fs:me,path:i})}catch(_c5){u=!0}}if(u)try{if(h=e(q+"releases/category-"+o.slug+".json"),200===(d=I.httpFetch(h,{method:"GET",responseType:"json"})).status){for(f=d.body,v=[],m="themes"===o.slug||o.name&&-1!==o.name.toLowerCase().indexOf("theme"),y=0;y<f.apps.length;y++){if(w=f.apps[y],T=!0,w["supported-devices"]&&!m){if(x=!1,"string"==typeof w["supported-devices"])x=new RegExp(w["supported-devices"]).test(s);else if(w["supported-devices"].length>0)for(b=0;b<w["supported-devices"].length;b++)if(S=w["supported-devices"][b],new RegExp(S).test(s)){x=!0;break}x||(T=!1)}T&&m&&w["supported-screen-size"]&&w["supported-screen-size"]!==n&&(T=!1),T&&v.push(w)}f.apps=v,f.count=v.length;try{L.write({fs:me,path:i},JSON.stringify(f,null,2),"write"),g>=0?t[g].lastUpdated=c:t.push({slug:o.slug,lastUpdated:c});try{L.write({fs:me,path:Q},JSON.stringify({categories:t},null,2),"write")}catch(_c6){}}catch(_c7){}}}catch(_c8){}}}}function f(e){var t,r;try{if("updates"===e.slug&&!I.connected())return ie=!1,void C("WiFi not connected. Connect via WiFi menu first.");if("updates"===e.slug)Y=ee;else{t=_+"category-"+e.slug+".json";try{(r=L.read({fs:me,path:t}))?Y=JSON.parse(r):b("Category data not available. Please restart app.")}catch(_c9){b("Error loading category data. Please restart app.")}}}catch(_c10){b("Error loading category: "+_c10.message)}ie=!1,C(),s()}function v(t){var r,s;try{if(r=e(q+"repositories/"+t.slug.replace(/ /g,"%20")+"/metadata.json"),200===(s=I.httpFetch(r,{method:"GET",responseType:"json"})).status)return s.body;b("Failed Loading Metadata (HTTP "+s.status+")")}catch(_c11){b("Network error (B): "+_c11.message)}}function m(){try{var e=L.read({fs:me,path:V});$=e?JSON.parse(e):{}}catch(_c12){$={}}$["BruceDevices/App-Store/App Store"]||($["BruceDevices/App-Store/App Store"]={version:"0.0.0",commit:""},y())}function y(){try{L.write({fs:me,path:V},JSON.stringify($,null,2),"write"),!ie&&Z&&k()}catch(_c13){}}function w(e){return $[e.slug]!==e.version}function T(e){var t,r=$[e.slug];return(t=r&&r.version?r.version:null)?t!==e.version?{text:"UPDATE AVAILABLE",color:W.orange}:{text:"UP TO DATE",color:W.green}:{text:"NOT INSTALLED",color:W.yellow}}function x(e){var t,r,s,n,a,o,i=e.split("\n"),c=[];for(t=0;t<i.length;t++)if((r=i[t]).length<=Ae)c.push(r);else{for(s=r.split(" "),n="",a=0;a<s.length;a++)(o=n+(n.length>0?" ":"")+s[a]).length<=Ae?n=o:n.length>0?(c.push(n),n=s[a]):c.push(s[a]);n.length>0&&c.push(n)}return c}function b(e){var t,r,s,n,a,o,i,c,l,g;if(t=!1,null==e||pe!==e&&(""!=e&&(t=!0),pe=e),t){for(B.setTextSize(1+Se),B.setTextColor(W.orange),B.setTextAlign("center","middle"),s=(r=x(pe)).length*(Se+1)*8+20,n=0,a=0;a<r.length;a++)r[a].length>n&&(n=r[a].length);for(o=n*(6*(1+Se)),i=Math.min(xe-20,o+40),c=(xe-i)/2,l=be/2-s/2,B.drawFillRect(c,l,i,s,W.black),B.drawRect(c,l,i,s,W.orange),a=0;a<r.length;a++)g=l+18+a*(Se+1)*8,B.drawText(r[a],xe/2,g)}}function S(){var e,t,r,s,n,a,o,i;if(Te){if(Te=!1,!ge||0===Y.apps.length)return;for(e=16*ve.length+24,t=Math.min(xe-40,200),r=(xe-t)/2,s=(be-e)/2,B.drawFillRect(r,s,t,e,W.black),B.drawRect(r,s,t,e,W.white),B.setTextSize(1+Se),n=0;n<ve.length;n++)a=s+16+n*(Se+1)*10,o=n===se?W.green:W.grey,i=n===se?"> ":"  ",B.setTextColor(o),B.setTextAlign("left","middle"),B.drawText(i+ve[n],r+10,a)}}function A(){var e,t,r,s,n,a,o;if(ye){if(ye=!1,0===X.totalCategories)return F("No categories available",1,"center","G6",W.red),void F("Check network connection",1,"center","G7",W.white);if(ge)return;if(e=X.categories[te].name,t=X.totalCategories,r=X.categories[te].count,"Updates"!==e){s=X.categories[te].slug,n=_+"category-"+s+".json";try{(a=L.read({fs:me,path:n}))&&void 0!==(o=JSON.parse(a)).count&&(r=o.count)}catch(_c14){}}F(te+1+" of "+t,1,"center","G3",W.white),F("Updates"===e?"* "+e+" *":e,2,"center","G5","Updates"===e?W.orange:W.green),F("Updates"===e?r+" Update"+(1===r?"":"s")+" Available":r+("Theme"===e?" theme":" App")+(1===r?"":"s"),1,"center","G7",W.white)}}function P(){var e,t,r,s,n,a,o,i;if(we){if(we=!1,B.drawFillRect(0,Pe+1,xe,be,W.black),0===Y.apps.length)return F("No apps in category",1,"center","G4",W.red),void F("Press ESC to go back",1,"center","G6",W.white);if(ge)return;t=T(e=Y.apps[te]),ae&&F(ae.name+"      "+(te+1)+" of "+Y.apps.length,1,"center","G2",W.white),B.setTextSize(2+Se),B.setTextColor(W.green),r=be/10*4,e.name.length>Ae?(s=e.name+"    ",n=de%s.length,a=(s.substring(n)+s.substring(0,n)).substring(0,Ae),B.setTextAlign("left","middle"),B.drawText(a,0,r)):(B.setTextAlign("center","middle"),B.drawText(e.name,xe/2,r)),B.setTextSize(1+Se),B.setTextColor(W.white),o=be/10*5+3*(Se+1)+3,e.description.length>Ae?(s=e.description+"    ",n=he%s.length,a=(s.substring(n)+s.substring(0,n)).substring(0,Ae),B.setTextAlign("left","middle"),B.drawText(a,0,o)):(B.setTextAlign("center","middle"),B.drawText(e.description,xe/2,o)),F(t.text,1,"center","G7",t.color),"UNKNOWN"!==e.version&&(i="None",$[e.slug]&&$[e.slug].version&&(i=$[e.slug].version),F("Available: "+e.version,1,"center","G8",W.grey),"None"!==i&&F("Installed: "+i,1,"center","G9",W.grey))}}function C(e,t,r){void 0===e&&(e=""),void 0===t&&(t=""),void 0===r&&(r=!1),r&&B.drawFillRect(0,Pe,xe,be,W.black),ge||G||(F("Bruce App Store",2,"center","G1",BRUCE_PRICOLOR),G=!0),e!=O&&(F(e,1,"center","G4",W.cyan),O=e),t!=R&&(F(t,1,"center","G6",W.white),R=t)}function F(e,t,r,s,n){var a,o=8*(2+Se);"center"==r&&(r=xe/2),"G"===s.substring(0,1)&&(a=parseInt(s.substring(1)),s=1==a?o:(be-o-4)/8*(a-1)+o+4),B.drawFillRect(0,s-8*(t+Se),xe,8*(t+Se),W.black),B.setTextAlign("center","bottom"),B.setTextColor(n),B.setTextSize(t+Se),B.drawText(e,r,s)}function N(t){var r,n,a,o,i,c,l,g,p,u;le=!0,C(t.name,"Connecting...",!0);try{if(!I.connected())return le=!1,void C("Error","WiFi not connected");for(C(t.name,"Installing..."),r=0,n=0,o=(a=v(t)).files||[],i="Themes"===a.category?K:M,c=0;c<o.length;c++)o[c]&&"object"==typeof o[c]&&o[c].source&&o[c].destination?(l=i+a.category+"/"+o[c].destination.replace(/^\/+/,""),g=(a.path+o[c].source).replace(/^\/+/,"")):(l=i+a.category+"/"+o[c].replace(/^\/+/,""),g=(a.path+o[c]).replace(/^\/+/,"")),p=e(p=("https://raw.githubusercontent.com/"+a.owner+"/"+a.repo+"/"+a.commit+"/"+g).replace(/ /g,"%20")),200===(u=I.httpFetch(p,{save:{fs:me,path:l,mode:"write"}})).status?(C(t.name,"Downloading "+(c+1)+" of "+o.length+"..."),r++):(n++,C("Error","Download failed: HTTP "+u.status+" for "+o[c].source));r===o.length&&0===n&&($[t.slug]={version:a.version,commit:a.commit},y(),we=!0,C("",""),P(),b("Installed successfully!"))}catch(_c15){C("Error","Error (A): "+_c15.message)}le=!1,s()}function k(){var e,t,r,s,n,a,o,i,c,l,g,p,u,h,d;try{if(ee={category:"Updates",slug:"updates",count:0,apps:[]},!X||!X.categories)return;for(e=0;e<X.categories.length;e++)if("updates"!==(t=X.categories[e]).slug){r=_+"category-"+t.slug+".json";try{if(s=L.read({fs:me,path:r}))for(n=JSON.parse(s),a=0;a<n.apps.length;a++)if(o=n.apps[a],i=$[o.slug],c=null,i&&i.version&&(c=i.version),c&&c!==o.version){for(l=!1,g=0;g<ee.apps.length;g++)if(ee.apps[g].slug===o.slug){l=!0;break}l||ee.apps.push(o)}}catch(_c16){}}for(ee.count=ee.apps.length,p=[],u=0;u<X.categories.length;u++)"updates"!==X.categories[u].slug&&p.push(X.categories[u]);if(X.categories=p,X.totalCategories=X.categories.length,ee.apps.length>0){for(h=[{name:"Updates",slug:"updates",count:ee.count}],d=0;d<X.categories.length;d++)h.push(X.categories[d]);X.categories=h,X.totalCategories=X.categories.length}}catch(_c17){b("Error creating Updates category: "+_c17.message)}}function E(e){re=te,ae=e,ne="scripts",te=0,c(),f(e),we=!0}function D(){B.drawFillRect(0,Pe+1,xe,be,W.black),ne="categories",te=re,Y=[],ae=null,c(),ye=!0}function U(e,t,r){0!==t&&(te=e?(te+1)%t:(te-1+t)%t,r&&r(),"categories"===ne?ye=!0:we=!0)}var G,O,R,j=require("device"),B=require("display"),z=require("keyboard"),L=require("storage"),I=require("wifi"),J=j.getFreeHeapSize(),W={black:B.color(0,0,0),grey:B.color(127,127,127),white:B.color(255,255,255),green:B.color(0,255,0),yellow:B.color(255,255,0),orange:B.color(255,165,0),red:B.color(255,0,0),cyan:B.color(0,255,255)},q="https://raw.githubusercontent.com/BruceDevices/App-Store-Data/refs/heads/main/",H=q+"releases/categories.json",M="/BruceJS/",K="/Themes/",V="/BruceAppStore/installed.json",_="/BruceAppStore/cache/",Q="/BruceAppStore/lastUpdated.json",X=[],Y=[],Z={},$={},ee=[],te=0,re=0,se=0,ne="categories",ae=null,oe=!1,ie=!1,ce=!1,le=!1,ge=!1,pe="",ue=0,he=0,de=0,fe=0,ve=[],me="littlefs",ye=!1,we=!1,Te=!1,xe=B.width(),be=B.height(),Se=xe>300?1:0,Ae=Math.trunc(xe/(6*(Se+1))),Pe=8*(2+Se);for(t(),m(),h(),G=!1,O="",R="";!oe;){if(z.getEscPress())if(ge)g();else{if("scripts"!==ne){oe=!0;break}D()}le||(""!=pe&&(z.getNextPress()||z.getPrevPress()||z.getSelPress()||z.getEscPress())?(pe="",ue=0,"categories"===ne?ye=!0:we=!0):ge?(z.getNextPress()?(se=(se+1)%ve.length,Te=!0):z.getPrevPress()&&(se=(se-1+ve.length)%ve.length,Te=!0),z.getSelPress()&&p(Y.apps[te])):"categories"===ne?z.getNextPress()?U(!0,X.totalCategories):z.getPrevPress()?U(!1,X.totalCategories):z.getSelPress()&&X.totalCategories>0&&E(X.categories[te]):z.getNextPress()?U(!0,Y.apps.length,c):z.getPrevPress()?U(!1,Y.apps.length,c):z.getSelPress()&&Y.apps.length>0&&l(Y.apps[te]),A(),P(),S()),n(),a(),delay(50)}
